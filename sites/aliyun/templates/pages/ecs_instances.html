{% extends "layouts/base.html" %}

{% block content %}
{% include 'components/navbar.html' %}

<main class="main-content" x-data="ecsInstances()">
    <div class="container">
        <h1>ECS 实例列表</h1>

        <!-- 区域选择和搜索 -->
        <div class="filters">
            <div class="filter-group">
                <label>地域:</label>
                <select x-model="regionId" @change="changeRegion()" :disabled="regionsLoading">
                    <template x-if="regionsLoading">
                        <option>加载中...</option>
                    </template>
                    <template x-if="!regionsLoading">
                        <template x-for="region in regions" :key="region.id">
                            <option :value="region.id" x-text="region.name" :selected="regionId === region.id"></option>
                        </template>
                    </template>
                </select>
            </div>
            <div class="filter-group">
                <input type="text" x-model="filters.instanceName" placeholder="实例名称" @keyup.enter="search()">
            </div>
            <div class="filter-group">
                <input type="text" x-model="filters.privateIp" placeholder="私网IP" @keyup.enter="search()">
            </div>
            <div class="filter-group">
                <input type="text" x-model="filters.publicIp" placeholder="公网IP" @keyup.enter="search()">
            </div>
            <div class="filter-group">
                <input type="text" x-model="filters.eipAddress" placeholder="EIP地址" @keyup.enter="search()">
            </div>
            <button @click="search()" class="btn btn-primary">搜索</button>
        </div>

        <!-- 错误提示 -->
        <div x-show="error" x-text="error" class="alert alert-error" x-cloak></div>

        <!-- 加载中 -->
        <div x-show="loading" class="loading" x-cloak>加载中...</div>

        <!-- 实例表格 -->
        <div x-show="!loading && !error" class="table-container" x-cloak>
            <table class="table">
                <thead>
                    <tr>
                        <th>实例名称</th>
                        <th>实例ID</th>
                        <th>状态</th>
                        <th>私网IP</th>
                        <th>公网IP</th>
                        <th>EIP</th>
                        <th>创建时间</th>
                    </tr>
                </thead>
                <tbody>
                    <template x-if="instances.length === 0">
                        <tr>
                            <td colspan="7" style="text-align: center; padding: 40px;">暂无数据</td>
                        </tr>
                    </template>
                    <template x-for="instance in instances" :key="instance.InstanceId">
                        <tr>
                            <td x-text="instance.InstanceName || '-'"></td>
                            <td x-text="instance.InstanceId"></td>
                            <td>
                                <span class="status-badge" :class="`status-${formatStatus(instance.Status).class}`" x-text="formatStatus(instance.Status).text"></span>
                            </td>
                            <td x-text="instance.VpcAttributes?.PrivateIpAddress?.IpAddress?.[0] || '-'"></td>
                            <td x-text="instance.PublicIpAddress?.IpAddress?.[0] || '-'"></td>
                            <td x-text="instance.EipAddress?.IpAddress || '-'"></td>
                            <td x-text="formatTime(instance.CreationTime)"></td>
                        </tr>
                    </template>
                </tbody>
            </table>
        </div>

        <!-- 分页 -->
        <div x-show="!loading && totalPages > 1" class="pagination" x-cloak>
            <button @click="prevPage()" :disabled="currentPage === 1">上一页</button>
            <span class="page-number" x-text="`第 ${currentPage} / ${totalPages} 页`"></span>
            <button @click="nextPage()" :disabled="currentPage === totalPages">下一页</button>
            <span class="pagination-info" x-text="`共 ${totalCount} 条，显示 ${startItem}-${endItem}`"></span>
            <div class="page-size-selector">
                <label>每页显示:</label>
                <select x-model="pageSize" @change="changePageSize()">
                    <option value="20">20条</option>
                    <option value="50">50条</option>
                    <option value="100">100条</option>
                </select>
            </div>
        </div>
    </div>
</main>
{% endblock %}

{% block extra_js %}
<script>
window.APP_CONFIG = {{ config|json|safe }};
</script>
<script src="{{ base_path }}/static/js/aliyun-api.js"></script>
<script src="{{ base_path }}/static/js/auth.js"></script>
{% endblock %}
